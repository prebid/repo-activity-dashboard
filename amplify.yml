version: 1
frontend:
  phases:
    preBuild:
      commands:
        # Check Node version
        - node --version
        - npm --version

        # Install dependencies with better error handling
        - echo "Installing dependencies..."
        - npm install --legacy-peer-deps --verbose || npm install --force
        - echo "Dependencies installed"

        # Check environment
        - echo "Environment check..."
        - 'echo "S3_BUCKET_NAME: $S3_BUCKET_NAME"'
        - 'echo "Current directory:"'
        - pwd
        - ls -la

        # Sync GitHub mapping from S3 (optional - continue if fails)
        - echo "Syncing from S3..."
        - npm run sync:mapping || echo "S3 sync skipped"

        # Verify critical files exist
        - echo "Verifying files..."
        - test -f contributor-repo-timeline.json || echo "Warning - contributor timeline missing"
        - test -f package.json || exit 1

    build:
      commands:
        # Increase Node memory for build
        - export NODE_OPTIONS=--max-old-space-size=4096

        # Build Next.js
        - echo "Building Next.js app..."
        - npm run build || exit 1
        - echo "Build successful"

  artifacts:
    baseDirectory: .next
    files:
      - '**/*'

  cache:
    paths:
      - node_modules/**/*